<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Number Typing Task</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #sequence-display {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #typing-area {
            width: 100%;
            height: 50px;
            font-size: 24px;
        }
        #download-data, #start-task, #clear-data {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #status {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>Number Typing Task</h1>
    <div id="instructions">
        <p>Please type the numbers displayed below into the text area. Once you have typed the 5 numbers, the next group will appear automatically. Type naturally; you may correct mistakes if you wish. Your keystrokes will be recorded for research purposes.</p>
    </div>

    <div id="sequence-display"></div>

    <textarea id="typing-area" placeholder="Type the numbers here..." disabled></textarea>

    <br>
    <button id="start-task">Start Task</button>
    <button id="download-data" disabled>Download Data</button>
    <button id="clear-data" disabled>Clear Data</button>

    <div id="status"></div>

    <script>
        const totalRepetitions = 10; 
        const digits = [...Array(10).keys()].map(String); // "0" to "9"
        const groupSize = 5; 

        let sequence = [];
        let currentGroupIndex = 0;
        let typedData = []; // Accumulate data across sessions
        let expectedInput = '';
        let currentPosition = 0;

        const sequenceDisplay = document.getElementById('sequence-display');
        const typingArea = document.getElementById('typing-area');
        const startTaskButton = document.getElementById('start-task');
        const downloadDataButton = document.getElementById('download-data');
        const clearDataButton = document.getElementById('clear-data');
        const statusDiv = document.getElementById('status');

        startTaskButton.addEventListener('click', startTask);
        downloadDataButton.addEventListener('click', downloadData);
        clearDataButton.addEventListener('click', clearData);
        typingArea.addEventListener('keydown', recordKeystroke);

        function generateSequence() {
            sequence = [];
            while (sequence.length < totalRepetitions * 10) {
                let newDigit = digits[Math.floor(Math.random() * digits.length)];
                if (sequence.length === 0 || sequence[sequence.length - 1] !== newDigit) {
                    sequence.push(newDigit);
                }
            }
        }

        function displayCurrentGroup() {
            if (currentGroupIndex < sequence.length) {
                const group = sequence.slice(currentGroupIndex, currentGroupIndex + groupSize);
                expectedInput = group.join('');
                currentPosition = 0;
                sequenceDisplay.textContent = group.join(' ');
                typingArea.value = '';
                typingArea.disabled = false;
                typingArea.focus();
                toggleButtons(true); // Disable buttons during task
            } else {
                endTask();
            }
        }

        function startTask() {
            generateSequence();
            currentGroupIndex = 0;
            statusDiv.textContent = 'Task in progress...';
            displayCurrentGroup();
        }

        function recordKeystroke(event) {
            const timestamp = Date.now();
            let actualKey = event.key;

            if (digits.includes(actualKey) || actualKey === 'Backspace') {
                typedData.push({ actualKey, timestamp });
            }

            if (event.key === 'Backspace') {
                if (currentPosition > 0) {
                    currentPosition--;
                }
            } else if (digits.includes(event.key)) {
                currentPosition++;
            } else {
                event.preventDefault(); 
            }

            if (currentPosition >= groupSize) {
                typingArea.disabled = true;
                currentGroupIndex += groupSize;
                setTimeout(() => {
                    displayCurrentGroup();
                }, 100);
            }
        }

        function endTask() {
            typingArea.disabled = true;
            startTaskButton.disabled = false;
            toggleButtons(false); // Enable buttons after task ends
            sequenceDisplay.textContent = 'Task completed!';
            statusDiv.textContent = 'You can start a new session or download your data.';
        }

        function downloadData() {
            // Filter out Backspace entries before exporting
            const filteredData = typedData.filter(row => row.actualKey !== 'Backspace');

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "actualKey,timestamp\n"; // headers

            filteredData.forEach(function(row) {
                csvContent += row.actualKey + "," + row.timestamp + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", encodedUri);
            downloadAnchorNode.setAttribute("download", "typed_data.csv");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            statusDiv.textContent = 'Data downloaded! You can continue typing or clear the data.';
        }

        function clearData() {
            typedData = []; // Clear accumulated data
            clearDataButton.disabled = true;
            downloadDataButton.disabled = true;
            statusDiv.textContent = 'Data cleared! Start a new session whenever you are ready.';
        }

        function toggleButtons(disabled) {
            downloadDataButton.disabled = disabled;
            clearDataButton.disabled = disabled;
        }
    </script>

</body>
</html>
