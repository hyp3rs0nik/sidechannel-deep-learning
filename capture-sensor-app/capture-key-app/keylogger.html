<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Number Typing Task</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        #sequence-display {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #typing-area {
            width: 100%;
            height: 50px;
            font-size: 24px;
        }
        #download-data, #start-task {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #status {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>Number Typing Task</h1>
    <div id="instructions">
        <p>Please type the numbers displayed below into the text area. Once you have typed the 5 numbers, the next group will appear automatically. Type naturally; you may correct mistakes if you wish. Your keystrokes will be recorded for research purposes.</p>
    </div>

    <div id="sequence-display"></div>

    <textarea id="typing-area" placeholder="Type the numbers here..." disabled></textarea>

    <br>
    <button id="start-task">Start Task</button>
    <button id="download-data" disabled>Download Data</button>

    <div id="status"></div>

    <script>
        const totalRepetitions = 10; 
        const digits = [...Array(10).keys()].map(String);
        const groupSize = 5; 

        let sequence = [];
        let currentGroupIndex = 0;
        let typedData = [];
        let expectedInput = '';
        let currentPosition = 0;

        const sequenceDisplay = document.getElementById('sequence-display');
        const typingArea = document.getElementById('typing-area');
        const startTaskButton = document.getElementById('start-task');
        const downloadDataButton = document.getElementById('download-data');
        const statusDiv = document.getElementById('status');

        startTaskButton.addEventListener('click', startTask);
        downloadDataButton.addEventListener('click', downloadData);
        typingArea.addEventListener('keydown', recordKeystroke);

        function generateSequence() {
            sequence = [];
            for (let i = 0; i < totalRepetitions; i++) {
                sequence = sequence.concat(digits);
            }
            shuffleArray(sequence);
        }

        function displayCurrentGroup() {
            if (currentGroupIndex < sequence.length) {
                const group = sequence.slice(currentGroupIndex, currentGroupIndex + groupSize);
                expectedInput = group.join('');
                currentPosition = 0;
                sequenceDisplay.textContent = group.join(' ');
                typingArea.value = '';
                typingArea.disabled = false;
                typingArea.focus();
            } else {
                endTask();
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startTask() {
            generateSequence();
            currentGroupIndex = 0;
            typedData = [];
            startTaskButton.disabled = true;
            downloadDataButton.disabled = true;
            statusDiv.textContent = 'Task in progress...';
            displayCurrentGroup();
        }

        function recordKeystroke(event) {
            const timestamp = Date.now();
            let actualKey = event.key;

            typedData.push({
                actualKey: actualKey,
                timestamp: timestamp,
            });

            if (event.key === 'Backspace') {
                if (currentPosition > 0) {
                    currentPosition--;
                }
            } else if (digits.includes(event.key)) {
                currentPosition++;
            } else {
                event.preventDefault();
            }

            if (currentPosition >= groupSize) {
                typingArea.disabled = true;
                currentGroupIndex += groupSize;
                setTimeout(() => {
                    displayCurrentGroup();
                }, 100);
            }
        }

        function endTask() {
            typingArea.disabled = true;
            startTaskButton.disabled = false;
            downloadDataButton.disabled = false;
            sequenceDisplay.textContent = 'Task completed!';
            statusDiv.textContent = 'You can download your data now.';
        }

        function downloadData() {
            // Convert typedData to CSV format
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "actualKey,timestamp\n"; // headers

            typedData.forEach(function(row) {
                csvContent += row.actualKey + "," + row.timestamp + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", encodedUri);
            downloadAnchorNode.setAttribute("download", "typed_data.csv");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>

</body>
</html>
